<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Book (Firebase Cloud Edition)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { --sidebar-width: 240px; --header-height: 40px; --primary-color: #0078d7; --bg-color: #f4f4f4; --btn-save: #28a745; --btn-update: #17a2b8; --btn-gen: #ffc107; --btn-print: #dc3545; --btn-navy: #001f3f; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; background-color: var(--bg-color); }
        *, *::before, *::after { box-sizing: border-box; }
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: var(--sidebar-width); background-color: #2d2d30; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 20px; background-color: #1e1e1e; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #444; }
        .menu-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #3e3e42; transition: 0.2s; font-size: 0.95rem; }
        .menu-item:hover { background-color: #3e3e42; padding-left: 25px; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .tabs-header { display: flex; background-color: #e6e6e6; height: var(--header-height); align-items: flex-end; padding-left: 5px; border-bottom: 1px solid #aaa; user-select: none; }
        .tab { padding: 8px 15px; margin-right: 2px; background-color: #cfcfcf; border: 1px solid #aaa; border-bottom: none; border-radius: 4px 4px 0 0; cursor: pointer; display: flex; align-items: center; font-size: 0.9rem; color: #555; }
        .tab.active { background-color: white; border-bottom: 1px solid white; font-weight: bold; color: black; margin-bottom: -1px; z-index: 10; }
        .tab:hover:not(.active) { background-color: #ddd; }
        .close-tab { margin-left: 10px; width: 16px; height: 16px; line-height: 14px; text-align: center; border-radius: 50%; font-size: 12px; color: #666; }
        .close-tab:hover { background-color: #c42b1c; color: white; }
        .tabs-body { flex: 1; background-color: white; padding: 20px; overflow-y: auto; position: relative; }
        .tab-pane { display: none; height: 100%; animation: fadeIn 0.2s; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .form-content-wrapper { max-width: 100%; height: 100%; display: flex; flex-direction: column; }
        .form-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 4px; font-size: 0.85rem; }
        input, select { padding: 6px 8px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.95rem; min-width: 120px; }
        input:focus, select:focus { outline: 2px solid var(--primary-color); border-color: var(--primary-color); }
        button { padding: 8px 16px; border: 1px solid transparent; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-gen { background-color: var(--btn-gen); color: black; }
        .btn-save { background-color: var(--btn-save); color: white; }
        .btn-update { background-color: var(--btn-update); color: white; }
        .btn-print { background-color: var(--btn-print); color: white; }
        .btn-navy { background-color: var(--btn-navy); color: white; }
        .grid-wrapper { flex: 1; border: 1px solid #ccc; overflow: auto; margin-bottom: 10px; background: white; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background-color: #e9ecef; position: sticky; top: 0; padding: 8px; border: 1px solid #ccc; text-align: center; font-size: 0.9rem; z-index: 2; }
        td { border: 1px solid #ddd; padding: 6px; text-align: center; font-size: 0.9rem; }
        td[contenteditable="true"]:focus { background-color: #e8f0fe; outline: none; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .split-container { display: flex; height: 100%; gap: 10px; }
        .split-left { flex: 0 0 400px; display: flex; flex-direction: column; border-right: 1px solid #ccc; padding-right: 10px; }
        .split-right { flex: 1; background-color: whitesmoke; padding: 20px; border-radius: 4px; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); display:flex; justify-content:center; align-items:center; z-index:999; font-size:1.5rem; display:none; }
        .status-bar { padding: 10px 20px; font-size: 0.8rem; background: #eee; border-top: 1px solid #ccc; display:flex; justify-content:space-between;}
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; background: gray; margin-right: 5px; }
        @media print {
            .sidebar, .tabs-header, .no-print, .status-bar { display: none !important; }
            .app-container { height: auto; display: block; }
            .main-content, .tabs-body, .tab-pane { height: auto; overflow: visible; padding: 0; margin: 0; }
            .grid-wrapper { border: none; height: auto; overflow: visible; }
            table { border: 2px solid black; }
            th, td { border: 1px solid black !important; color: black; }
            .print-only { display: block !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>

    <div class="loading-overlay" id="loading">Loading...</div>

    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">Galaxy Book (Cloud)</div>
            <div class="menu-item" onclick="app.openTab('form1', 'Data Entry')">Data Entry</div>
            <div class="menu-item" onclick="app.openTab('form2', 'Rate Master')">Rate Master</div>
            <div class="menu-item" onclick="app.openTab('form3', 'Daily Report')">Daily Report</div>
            <div class="menu-item" onclick="app.openTab('form4', 'Employee Master')">Employee Master</div>
            <div class="menu-item" onclick="app.openTab('form5', 'Settings')">Settings</div>
            <div class="menu-item" onclick="app.openTab('form6', 'Backup & Restore')">Backup & Restore</div>
        </div>

        <div class="main-content">
            <div class="tabs-header" id="tabsHeader"></div>
            <div class="tabs-body" id="tabsBody">
                <div id="welcome-msg" style="padding: 40px; text-align: center; color: #777;">
                    <h2>Welcome to Galaxy Book</h2>
                    <p>Select an option from the menu.</p>
                </div>
            </div>
            <div class="status-bar">
                <div><span id="conn-status" class="status-indicator"></span> <span id="conn-text">Connecting...</span></div>
                <div>Galaxy Book v2.0</div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBh8rTtRssy9j7UELcVmbilv7cQwFtDl8o",
            authDomain: "galaxybook-1bbc7.firebaseapp.com",
            databaseURL: "https://galaxybook-1bbc7-default-rtdb.firebaseio.com",
            projectId: "galaxybook-1bbc7",
            storageBucket: "galaxybook-1bbc7.firebasestorage.app",
            messagingSenderId: "424415030072",
            appId: "1:424415030072:web:c2790e3d465e3cd3992fcd",
            measurementId: "G-SX2KFZ3PXW"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // AUTH & CONNECTION HANDLING
        function updateStatus(connected, text) {
            const ind = document.getElementById('conn-status');
            const txt = document.getElementById('conn-text');
            ind.style.backgroundColor = connected ? '#28a745' : 'red';
            txt.innerText = text;
        }

        auth.signInAnonymously()
            .then(() => {
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", (snap) => {
                    if (snap.val() === true) {
                        updateStatus(true, "Connected to Cloud");
                    } else {
                        updateStatus(false, "Disconnected");
                    }
                });
            })
            .catch((error) => {
                updateStatus(false, "Auth Error: " + error.message);
                alert("Authentication Failed: " + error.message);
            });


        // --- 2. ASYNC DATA STORE ---
        const DB = {
            KEYS: {
                MASTER: 'EmployeeMaster',
                DATA: 'EmployeeData',
                RATES: 'RateMaster',
                SHORTCUTS: 'ShortcutSettings'
            },
            get: async (key) => {
                app.loading(true);
                try {
                    const snapshot = await database.ref(key).once('value');
                    const val = snapshot.val();
                    if (!val) return [];
                    return Array.isArray(val) ? val : Object.values(val); 
                } catch (e) {
                    alert("Database Access Error: " + e.message);
                    return [];
                } finally {
                    app.loading(false);
                }
            },
            set: async (key, data) => {
                app.loading(true);
                try {
                    await database.ref(key).set(data);
                } catch (e) {
                    alert("Save Error: " + e.message);
                } finally {
                    app.loading(false);
                }
            }
        };

        // --- 3. GLOBAL APP CONTROLLER ---
        const app = {
            activeTabs: [],
            
            loading: (show) => {
                document.getElementById('loading').style.display = show ? 'flex' : 'none';
            },

            openTab: (id, title) => {
                if (app.activeTabs.includes(id)) {
                    app.activateTab(id);
                    return;
                }

                // REMOVING WELCOME MESSAGE: If this is the first tab, clear the container
                if (app.activeTabs.length === 0) {
                    document.getElementById('tabsBody').innerHTML = '';
                }

                const header = document.createElement('div');
                header.className = 'tab';
                header.id = `tab-head-${id}`;
                header.innerHTML = `${title} <span class="close-tab" onclick="app.closeTab(event, '${id}')">✕</span>`;
                header.onclick = (e) => { if (!e.target.classList.contains('close-tab')) app.activateTab(id); };
                document.getElementById('tabsHeader').appendChild(header);

                const body = document.createElement('div');
                body.className = 'tab-pane';
                body.id = `tab-body-${id}`;
                body.innerHTML = templates[id]();
                document.getElementById('tabsBody').appendChild(body);

                app.activeTabs.push(id);
                app.activateTab(id);

                if (controllers[id]) controllers[id].init();
            },

            activateTab: (id) => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                document.getElementById(`tab-head-${id}`).classList.add('active');
                document.getElementById(`tab-body-${id}`).classList.add('active');
            },

            closeTab: (e, id) => {
                e.stopPropagation();
                document.getElementById(`tab-head-${id}`).remove();
                document.getElementById(`tab-body-${id}`).remove();
                app.activeTabs = app.activeTabs.filter(t => t !== id);
                
                // RESTORE WELCOME MESSAGE: If no tabs are left
                if (app.activeTabs.length > 0) {
                    app.activateTab(app.activeTabs[app.activeTabs.length - 1]);
                } else {
                    document.getElementById('tabsBody').innerHTML = `
                        <div id="welcome-msg" style="padding: 40px; text-align: center; color: #777;">
                            <h2>Welcome to Galaxy Book</h2>
                            <p>Select an option from the menu.</p>
                        </div>`;
                }
            }
        };

        // --- 4. HTML TEMPLATES ---
        const templates = {
            form1: () => `
                <div class="form-content-wrapper" id="f1-ctx">
                    <h3>Data Entry</h3>
                    <div class="form-row">
                        <div class="form-group"><label>English Name</label><select id="f1-cmbName" style="width:200px"></select></div>
                        <div class="form-group"><label>Gujarati Name</label><input id="f1-txtGuj" readonly style="background:#eee"></div>
                        <div class="form-group"><label>Date</label><input type="date" id="f1-dtp"></div>
                        <div class="form-group"><br><button class="btn-gen" onclick="controllers.form1.generate()">Generate (Alt+G)</button></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Type</label><select id="f1-cmbType"><option>પેલ</option><option>મથાળા</option></select></div>
                        <div class="form-group"><label style="color:red">Uppad</label><input type="number" id="f1-txtUppad" value="0" style="text-align:right"></div>
                    </div>
                    <div class="grid-wrapper">
                        <table id="f1-grid">
                            <thead><tr><th width="40">#</th><th>A</th><th>B</th><th>C</th><th>D</th><th>E</th><th>F</th><th>G</th><th>Ct</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div style="margin-top:10px">
                        <button onclick="controllers.form1.addRow()" style="background:#eee">+ Add Row</button>
                        <button id="f1-btnSave" class="btn-save" style="width:200px; margin-left:20px" onclick="controllers.form1.save()">Save Data (Alt+S)</button>
                        <button id="f1-btnUpdate" class="btn-update" style="width:200px; margin-left:20px; display:none" onclick="controllers.form1.update()">Update Data (Alt+U)</button>
                    </div>
                </div>`,
            
            form2: () => `
                <div class="form-content-wrapper" style="max-width:500px">
                    <h3>Rate Master</h3>
                    <div class="form-group" style="margin-bottom:20px">
                        <label>Entry Type</label>
                        <select id="f2-cmbType" onchange="controllers.form2.load()"><option>પેલ</option><option>મથાળા</option></select>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                        ${['A','B','C','D','E','F','G'].map(k => `<div><label>Rate ${k}</label><input type="number" id="f2-txt${k}" class="rate-in" value="0"></div>`).join('')}
                    </div>
                    <br><button class="btn-save" onclick="controllers.form2.save()">Save Rates (Alt+S)</button>
                </div>`,

            form3: () => `
                <div class="form-content-wrapper">
                    <div class="no-print">
                        <h3>Daily Report</h3>
                        <div class="form-row">
                            <div class="form-group"><label>From</label><input type="date" id="f3-dtpFrom"></div>
                            <div class="form-group"><label>To</label><input type="date" id="f3-dtpTo"></div>
                            <div class="form-group"><label>Type</label><select id="f3-cmbType"><option>પેલ</option><option>મથાળા</option></select></div>
                            <div class="form-group"><br><button class="btn-navy" onclick="controllers.form3.load()">Show</button></div>
                            <div class="form-group"><br><button class="btn-print" onclick="window.print()">Print (Ctrl+P)</button></div>
                        </div>
                    </div>
                    <div class="print-only" style="text-align:center">
                        <h2>WORK REPORT (<span id="f3-printType"></span>)</h2>
                        <p id="f3-printRange"></p>
                    </div>
                    <div class="grid-wrapper">
                        <table id="f3-grid"><thead><tr id="f3-head-row"></tr></thead><tbody></tbody></table>
                    </div>
                    <div id="f3-total" style="font-weight:bold; padding:10px; border-top:2px solid #ccc"></div>
                </div>`,

            form4: () => `
                <div class="split-container">
                    <div class="split-left">
                        <input placeholder="Search..." id="f4-search" onkeyup="controllers.form4.filter()" style="margin-bottom:5px">
                        <div class="grid-wrapper"><table id="f4-grid"><thead><tr><th>ID</th><th>Name</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div class="split-right">
                        <h3>Employee Details</h3>
                        <div class="form-group"><label>ID</label><input id="f4-id" readonly style="background:#ddd; width:100px"></div><br>
                        <div class="form-group"><label>English Name</label><input id="f4-eng" onblur="controllers.form4.translate()"></div><br>
                        <div class="form-group"><label>Gujarati Name</label><input id="f4-guj" readonly></div><br>
                        <div class="form-group"><label>Type</label><select id="f4-type"><option>પેલ</option><option>મથાળા</option></select></div><br>
                        <div class="form-group"><label>Active</label><select id="f4-active"><option>Yes</option><option>No</option></select></div><br>
                        <div class="form-row">
                            <button class="btn-navy" onclick="controllers.form4.save()">Save (Alt+S)</button>
                            <button class="btn-gen" onclick="controllers.form4.new()">New (Alt+N)</button>
                        </div>
                    </div>
                </div>`,

            form5: () => `
                <div class="form-content-wrapper" style="max-width:400px">
                    <h3>Shortcut Settings</h3>
                    <p style="color:#666; font-size:0.9rem">Click box and press key combo.</p>
                    ${['Save','Generate','Update','Print','New','Close'].map(k => `<div class="form-group" style="margin-bottom:10px"><label>${k}</label><input id="f5-${k}" readonly onkeydown="controllers.form5.capture(event, this)"></div>`).join('')}
                    <button class="btn-navy" onclick="controllers.form5.save()">Save Settings</button>
                </div>`,

            form6: () => `
                <div class="form-content-wrapper" style="max-width:500px">
                    <h3>Backup & Restore</h3>
                    <div style="padding:20px; border:1px solid #ccc; border-radius:5px; background:white">
                        <h4>Backup</h4>
                        <p>Download all data as a JSON file.</p>
                        <button class="btn-save" onclick="controllers.form6.backup()">Download Backup</button>
                    </div>
                    <br>
                    <div style="padding:20px; border:1px solid #ccc; border-radius:5px; background:white">
                        <h4>Restore</h4>
                        <p style="color:red">Warning: This will overwrite ALL Cloud data!</p>
                        <input type="file" id="f6-file" accept=".json">
                        <br><br>
                        <button class="btn-print" onclick="controllers.form6.restore()">Restore Data</button>
                    </div>
                </div>`
        };

        // --- 5. ASYNC FORM LOGIC CONTROLLERS ---
        const controllers = {
            
            form1: {
                init: async () => {
                    document.getElementById('f1-dtp').valueAsDate = new Date();
                    await controllers.form1.loadMaster();
                    for(let i=0; i<5; i++) controllers.form1.addRow();
                    
                    document.getElementById('f1-cmbName').onchange = (e) => {
                        const opt = e.target.options[e.target.selectedIndex];
                        document.getElementById('f1-txtGuj').value = opt.dataset.guj || "";
                    };
                },
                loadMaster: async () => {
                    const masters = await DB.get(DB.KEYS.MASTER);
                    const activeMasters = masters.filter(m => m.Active === "Yes");
                    const cmb = document.getElementById('f1-cmbName');
                    cmb.innerHTML = '<option value="">-- Select --</option>';
                    activeMasters.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.EnglishName;
                        opt.text = m.EnglishName;
                        opt.dataset.guj = m.GujaratiName;
                        cmb.appendChild(opt);
                    });
                },
                addRow: (data = null) => {
                    const tbody = document.querySelector('#f1-grid tbody');
                    const tr = document.createElement('tr');
                    const c = (v) => `<td contenteditable="true">${v||''}</td>`;
                    tr.innerHTML = `<td style="background:#eee">#</td>${c(data?.Col_A)}${c(data?.Col_B)}${c(data?.Col_C)}${c(data?.Col_D)}${c(data?.Col_E)}${c(data?.Col_F)}${c(data?.Col_G)}${c(data?.Col_Ct)}`;
                    if(data?.Id) tr.dataset.id = data.Id;
                    tbody.appendChild(tr);
                },
                generate: async () => {
                    const name = document.getElementById('f1-cmbName').value;
                    const date = document.getElementById('f1-dtp').value;
                    const type = document.getElementById('f1-cmbType').value;
                    if(!name) return alert("Select Name");

                    const allData = await DB.get(DB.KEYS.DATA);
                    const rows = allData.filter(x => x.EmpName_English === name && x.EntryDate === date && x.EntryType === type);

                    const tbody = document.querySelector('#f1-grid tbody');
                    tbody.innerHTML = '';
                    
                    if(rows.length > 0) {
                        document.getElementById('f1-txtUppad').value = rows[0].Uppad;
                        rows.forEach(r => controllers.form1.addRow(r));
                        document.getElementById('f1-btnSave').style.display = 'none';
                        document.getElementById('f1-btnUpdate').style.display = 'inline-block';
                    } else {
                        document.getElementById('f1-txtUppad').value = 0;
                        for(let i=0; i<5; i++) controllers.form1.addRow();
                        document.getElementById('f1-btnSave').style.display = 'inline-block';
                        document.getElementById('f1-btnUpdate').style.display = 'none';
                    }
                },
                collect: () => {
                    const rows = document.querySelectorAll('#f1-grid tbody tr');
                    const out = [];
                    const common = {
                        EmpName_English: document.getElementById('f1-cmbName').value,
                        EmpName_Gujarati: document.getElementById('f1-txtGuj').value,
                        EntryDate: document.getElementById('f1-dtp').value,
                        EntryType: document.getElementById('f1-cmbType').value,
                        Uppad: document.getElementById('f1-txtUppad').value
                    };
                    rows.forEach(tr => {
                        const tds = tr.querySelectorAll('td');
                        if(tds[1].innerText.trim() || tds[2].innerText.trim()) {
                            out.push({
                                ...common,
                                Id: tr.dataset.id ? parseInt(tr.dataset.id) : Date.now() + Math.random(),
                                Col_A: tds[1].innerText, Col_B: tds[2].innerText, Col_C: tds[3].innerText,
                                Col_D: tds[4].innerText, Col_E: tds[5].innerText, Col_F: tds[6].innerText,
                                Col_G: tds[7].innerText, Col_Ct: tds[8].innerText
                            });
                        }
                    });
                    return out;
                },
                save: async () => {
                    const newData = controllers.form1.collect();
                    if(newData.length === 0) return alert("Grid Empty");
                    const all = await DB.get(DB.KEYS.DATA);
                    await DB.set(DB.KEYS.DATA, [...all, ...newData]);
                    alert("Saved to Cloud!");
                    await controllers.form1.generate();
                },
                update: async () => {
                    const newData = controllers.form1.collect();
                    const name = document.getElementById('f1-cmbName').value;
                    const date = document.getElementById('f1-dtp').value;
                    const type = document.getElementById('f1-cmbType').value;
                    
                    let all = await DB.get(DB.KEYS.DATA);
                    all = all.filter(x => !(x.EmpName_English === name && x.EntryDate === date && x.EntryType === type));
                    
                    await DB.set(DB.KEYS.DATA, [...all, ...newData]);
                    alert("Updated in Cloud!");
                    await controllers.form1.generate();
                }
            },

            form2: {
                init: () => controllers.form2.load(),
                load: async () => {
                    const type = document.getElementById('f2-cmbType').value;
                    const allRates = await DB.get(DB.KEYS.RATES);
                    const rates = allRates.find(r => r.RateType === type) || {};
                    ['A','B','C','D','E','F','G'].forEach(k => document.getElementById(`f2-txt${k}`).value = rates[`Val_${k}`] || 0);
                },
                save: async () => {
                    const type = document.getElementById('f2-cmbType').value;
                    const allRates = await DB.get(DB.KEYS.RATES);
                    let filtered = allRates.filter(r => r.RateType !== type);
                    
                    const newRate = { RateType: type };
                    ['A','B','C','D','E','F','G'].forEach(k => newRate[`Val_${k}`] = document.getElementById(`f2-txt${k}`).value);
                    
                    filtered.push(newRate);
                    await DB.set(DB.KEYS.RATES, filtered);
                    alert("Rates Saved");
                }
            },

            form3: {
                init: () => {
                    const today = new Date();
                    document.getElementById('f3-dtpFrom').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    document.getElementById('f3-dtpTo').valueAsDate = today;
                },
                load: async () => {
                    const from = document.getElementById('f3-dtpFrom').value;
                    const to = document.getElementById('f3-dtpTo').value;
                    const type = document.getElementById('f3-cmbType').value;

                    document.getElementById('f3-printType').innerText = type;
                    document.getElementById('f3-printRange').innerText = `${from} to ${to}`;

                    // Fetch all data in parallel for speed
                    app.loading(true);
                    const [allRates, allMasters, allEntries] = await Promise.all([
                        DB.get(DB.KEYS.RATES),
                        DB.get(DB.KEYS.MASTER),
                        DB.get(DB.KEYS.DATA)
                    ]);
                    app.loading(false);

                    const rate = allRates.find(r => r.RateType === type) || {};
                    const masters = allMasters.filter(m => m.EntryType === type);
                    const entries = allEntries.filter(x => x.EntryDate >= from && x.EntryDate <= to && x.EntryType === type);

                    const thead = document.getElementById('f3-head-row');
                    thead.innerHTML = `<th>Name</th>${['A','B','C','D','E','F','G'].map(k => `<th>${rate[`Val_${k}`] || k}</th>`).join('')}<th>Ct</th><th>Total</th><th>Work</th><th>Uppad</th><th>Jama</th>`;

                    const tbody = document.querySelector('#f3-grid tbody');
                    tbody.innerHTML = '';
                    let gWork = 0, gUppad = 0, gJama = 0;

                    masters.forEach(m => {
                        const pData = entries.filter(x => x.EmpName_English === m.EnglishName);
                        if(pData.length === 0) return;

                        const sums = {};
                        ['A','B','C','D','E','F','G'].forEach(k => sums[k] = pData.reduce((acc, c) => acc + (parseInt(c[`Col_${k}`])||0), 0));
                        const sCt = pData.reduce((acc, c) => acc + (parseFloat(c.Col_Ct)||0), 0);
                        const sUppad = pData.reduce((acc, c) => acc + (parseFloat(c.Uppad)||0), 0);
                        
                        let work = 0;
                        ['A','B','C','D','E','F','G'].forEach(k => work += sums[k] * (parseFloat(rate[`Val_${k}`])||0));
                        work += sCt * (parseFloat(rate.Val_G)||0);

                        const count = Object.values(sums).reduce((a,b)=>a+b, 0);
                        const jama = work - sUppad;

                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td style="text-align:left;font-weight:bold">${m.EnglishName}</td>
                            ${['A','B','C','D','E','F','G'].map(k => `<td>${sums[k]||''}</td>`).join('')}
                            <td>${sCt||''}</td><td style="background:#eee;font-weight:bold">${count}</td>
                            <td style="background:#e3f2fd">${work.toFixed(0)}</td>
                            <td style="color:red">${sUppad.toFixed(0)}</td>
                            <td style="font-weight:bold;color:${jama>=0?'green':'red'}">${jama.toFixed(0)}</td>`;
                        tbody.appendChild(tr);

                        gWork += work; gUppad += sUppad; gJama += jama;
                    });

                    document.getElementById('f3-total').innerText = `Totals -> Work: ${gWork.toFixed(0)} | Uppad: ${gUppad.toFixed(0)} | Jama: ${gJama.toFixed(0)}`;
                }
            },

            form4: {
                init: () => {
                    controllers.form4.refreshGrid();
                    controllers.form4.new();
                    
                    const tbody = document.querySelector('#f4-grid tbody');
                    tbody.onclick = (e) => {
                        const tr = e.target.closest('tr');
                        if(!tr) return;
                        const id = parseInt(tr.cells[0].innerText);
                        controllers.form4.loadDetails(id);
                    };
                },
                refreshGrid: async () => {
                    const list = await DB.get(DB.KEYS.MASTER);
                    const tbody = document.querySelector('#f4-grid tbody');
                    tbody.innerHTML = list.map(m => `<tr><td>${m.EmployeeID}</td><td>${m.EnglishName}</td></tr>`).join('');
                },
                loadDetails: async (id) => {
                    const list = await DB.get(DB.KEYS.MASTER);
                    const emp = list.find(m => m.EmployeeID === id);
                    if(emp) {
                        document.getElementById('f4-id').value = emp.EmployeeID;
                        document.getElementById('f4-eng').value = emp.EnglishName;
                        document.getElementById('f4-guj').value = emp.GujaratiName;
                        document.getElementById('f4-type').value = emp.EntryType;
                        document.getElementById('f4-active').value = emp.Active;
                    }
                },
                new: () => {
                    document.getElementById('f4-id').value = '';
                    document.getElementById('f4-eng').value = '';
                    document.getElementById('f4-guj').value = '';
                    document.getElementById('f4-eng').focus();
                },
                save: async () => {
                    const idVal = document.getElementById('f4-id').value;
                    const eng = document.getElementById('f4-eng').value;
                    if(!eng) return;

                    let list = await DB.get(DB.KEYS.MASTER);
                    const obj = {
                        EmployeeID: idVal ? parseInt(idVal) : (list.length > 0 ? Math.max(...list.map(x=>x.EmployeeID))+1 : 1),
                        EnglishName: eng,
                        GujaratiName: document.getElementById('f4-guj').value,
                        EntryType: document.getElementById('f4-type').value,
                        Active: document.getElementById('f4-active').value
                    };

                    if(idVal) {
                        list = list.map(x => x.EmployeeID === obj.EmployeeID ? obj : x);
                    } else {
                        list.push(obj);
                    }
                    await DB.set(DB.KEYS.MASTER, list);
                    alert("Saved to Cloud");
                    await controllers.form4.refreshGrid();
                    controllers.form4.new();
                },
                translate: () => {
                    const val = document.getElementById('f4-eng').value;
                    if(val && !document.getElementById('f4-guj').value) {
                        document.getElementById('f4-guj').value = val + " (Guj)"; 
                    }
                },
                filter: () => {
                    const q = document.getElementById('f4-search').value.toLowerCase();
                    const rows = document.querySelectorAll('#f4-grid tbody tr');
                    rows.forEach(r => {
                        r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
                    });
                }
            },

            form5: {
                init: async () => {
                    const sets = await DB.get(DB.KEYS.SHORTCUTS);
                    if(sets.length) {
                        sets.forEach(s => {
                            const el = document.getElementById(`f5-${s.ActionName}`);
                            if(el) el.value = s.KeyCode;
                        });
                    }
                },
                capture: (e, el) => {
                    e.preventDefault();
                    let code = "";
                    if(e.altKey) code += "Alt+";
                    if(e.ctrlKey) code += "Ctrl+";
                    if(e.shiftKey) code += "Shift+";
                    code += e.key.toUpperCase();
                    el.value = code;
                },
                save: async () => {
                    const out = [];
                    ['Save','Generate','Update','Print','New','Close'].forEach(k => {
                        out.push({ ActionName: k, KeyCode: document.getElementById(`f5-${k}`).value });
                    });
                    await DB.set(DB.KEYS.SHORTCUTS, out);
                    alert("Shortcuts Updated in Cloud");
                }
            },

            form6: {
                init: () => {},
                backup: async () => {
                    app.loading(true);
                    const backupData = {
                        EmployeeMaster: await DB.get(DB.KEYS.MASTER),
                        EmployeeData: await DB.get(DB.KEYS.DATA),
                        RateMaster: await DB.get(DB.KEYS.RATES),
                        ShortcutSettings: await DB.get(DB.KEYS.SHORTCUTS)
                    };
                    app.loading(false);

                    const blob = new Blob([JSON.stringify(backupData)], {type : 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `GalaxyCloudBackup_${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                },
                restore: () => {
                    const file = document.getElementById('f6-file').files[0];
                    if(!file) return alert("Select file");
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            app.loading(true);
                            if(data.EmployeeMaster) await DB.set(DB.KEYS.MASTER, data.EmployeeMaster);
                            if(data.EmployeeData) await DB.set(DB.KEYS.DATA, data.EmployeeData);
                            if(data.RateMaster) await DB.set(DB.KEYS.RATES, data.RateMaster);
                            if(data.ShortcutSettings) await DB.set(DB.KEYS.SHORTCUTS, data.ShortcutSettings);
                            app.loading(false);
                            alert("Cloud Restore Complete! Reloading...");
                            location.reload();
                        } catch(err) { alert("Invalid File: " + err); }
                    };
                    reader.readAsText(file);
                }
            }
        };

        // --- GLOBAL KEYBOARD HANDLER ---
        document.addEventListener('keydown', (e) => {
            if (e.altKey && e.key === 'g') { e.preventDefault(); if(document.getElementById('f1-ctx')) controllers.form1.generate(); }
            if (e.altKey && e.key === 's') { 
                e.preventDefault(); 
                if(document.querySelector('.tab.active').id.includes('form1')) controllers.form1.save();
                if(document.querySelector('.tab.active').id.includes('form2')) controllers.form2.save();
                if(document.querySelector('.tab.active').id.includes('form4')) controllers.form4.save();
            }
        });

    </script>
</body>
</html>