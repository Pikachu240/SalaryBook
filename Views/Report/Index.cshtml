@{
    ViewData["Title"] = "Daily Report";
}

<style>
    /* Notice the double @@ below */
    @@media print {
        /* Hide buttons and inputs when printing */
        .no-print, header, footer, .navbar {
            display: none !important;
        }
        /* Make table look like a report */
        .card {
            border: none !important;
            shadow: none !important;
        }

        .card-body {
            padding: 0 !important;
        }

        body {
            background-color: white;
        }

        h3 {
            display: block;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th, td {
            border: 1px solid black !important;
            padding: 4px;
            text-align: center;
        }
    }

    /* Screen Styles */
    th {
        font-size: 0.9rem;
        text-align: center;
        background-color: #f8f9fa;
    }

    td {
        text-align: center;
        font-weight: 500;
    }

    .text-right {
        text-align: right;
    }
</style>

<div class="container-fluid">

    <div class="card shadow-sm mb-3 no-print">
        <div class="card-body p-3">
            <div class="row g-2 align-items-end">
                <div class="col-md-2">
                    <label>From Date</label>
                    <input type="date" id="dtpFrom" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-2">
                    <label>To Date</label>
                    <input type="date" id="dtpTo" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-2">
                    <label>Type</label>
                    <select id="cmbType" class="form-select">
                        <option value="પેલ">પેલ (Pel)</option>
                        <option value="મથાળા">મથાળા (Mathala)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100 fw-bold" onclick="loadReport()">Show</button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-danger w-100 fw-bold" onclick="window.print()">Print (Ctrl+P)</button>
                </div>
            </div>
        </div>
    </div>

    <h3 class="text-center mb-3 d-none d-print-block">WORK REPORT</h3>

    <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover" id="tblReport">
            <thead class="table-dark">
                <tr>
                    <th style="width:200px; text-align:left;">Name</th>
                    <th id="hA">A</th>
                    <th id="hB">B</th>
                    <th id="hC">C</th>
                    <th id="hD">D</th>
                    <th id="hE">E</th>
                    <th id="hF">F</th>
                    <th id="hG">G</th>
                    <th>Count</th>
                    <th>Total Kam</th>
                    <th>Uppad</th>
                    <th>Jama</th>
                </tr>
            </thead>
            <tbody>
            </tbody>

            <tfoot class="table-secondary fw-bold">
                <tr>
                    <td style="text-align:left;">TOTAL</td>
                    <td id="sumA"></td>
                    <td id="sumB"></td>
                    <td id="sumC"></td>
                    <td id="sumD"></td>
                    <td id="sumE"></td>
                    <td id="sumF"></td>
                    <td id="sumG"></td>

                    <td id="sumCount">0</td>
                    <td id="sumKam">0</td>
                    <td id="sumUppad">0</td>
                    <td id="sumJama">0</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        function loadReport() {
            var from = $('#dtpFrom').val();
            var to = $('#dtpTo').val();
            var type = $('#cmbType').val();

            // Show Loading
            $('#tblReport tbody').html('<tr><td colspan="12">Loading...</td></tr>'); // Colspan updated to 12

            $.get(`/Report/GetReport?fromDate=${from}&toDate=${to}&type=${type}`, function (data) {

                // 1. Update Headers with Rates
                $('#hA').text(data.rateA > 0 ? data.rateA : 'A');
                $('#hB').text(data.rateB > 0 ? data.rateB : 'B');
                $('#hC').text(data.rateC > 0 ? data.rateC : 'C');
                $('#hD').text(data.rateD > 0 ? data.rateD : 'D');
                $('#hE').text(data.rateE > 0 ? data.rateE : 'E');
                $('#hF').text(data.rateF > 0 ? data.rateF : 'F');
                $('#hG').text(data.rateG > 0 ? data.rateG : 'G');

                // 2. Render Rows & Calculate Footers
                var tbody = $('#tblReport tbody');
                tbody.empty();

                // Initialize Column Totals
                var sumA = 0, sumB = 0, sumC = 0, sumD = 0, sumE = 0, sumF = 0, sumG = 0;
                var totalCount = 0, totalKam = 0, totalUppad = 0, totalJama = 0;

                if (data.rows.length === 0) {
                    tbody.html('<tr><td colspan="12">No Data Found</td></tr>');
                }

                $.each(data.rows, function (i, r) {
                    // Sum columns A-G
                    sumA += r.a;
                    sumB += r.b;
                    sumC += r.c;
                    sumD += r.d;
                    sumE += r.e;
                    sumF += r.f;
                    sumG += r.g;

                    // Sum Grand Totals
                    totalCount += r.totalCount;
                    totalKam += r.totalKam;
                    totalUppad += r.uppad;
                    totalJama += r.jama;

                    // REMOVED r.ct from the row HTML
                    var row = `<tr>
                        <td style="text-align:left;">${r.name}</td>
                        <td>${format(r.a)}</td>
                        <td>${format(r.b)}</td>
                        <td>${format(r.c)}</td>
                        <td>${format(r.d)}</td>
                        <td>${format(r.e)}</td>
                        <td>${format(r.f)}</td>
                        <td>${format(r.g)}</td>
                        <td class="fw-bold">${format(r.totalCount)}</td>
                        <td class="text-success">${format(r.totalKam)}</td>
                        <td class="text-danger">${format(r.uppad)}</td>
                        <td class="fw-bold">${format(r.jama)}</td>
                    </tr>`;
                    tbody.append(row);
                });

                // 3. Update Footer Cells
                $('#sumA').text(format(sumA));
                $('#sumB').text(format(sumB));
                $('#sumC').text(format(sumC));
                $('#sumD').text(format(sumD));
                $('#sumE').text(format(sumE));
                $('#sumF').text(format(sumF));
                $('#sumG').text(format(sumG));

                $('#sumCount').text(format(totalCount));
                $('#sumKam').text(format(totalKam));
                $('#sumUppad').text(format(totalUppad));
                $('#sumJama').text(format(totalJama));
            });
        }

        // Helper to hide 0 values or format numbers
        function format(val) {
            if (val === 0 || val === '0') return '';
            return val;
        }
    </script>
}