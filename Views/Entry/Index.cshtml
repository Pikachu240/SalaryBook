@{
    ViewData["Title"] = "Daily Entry";
}

<div class="container-fluid">
    <h3 class="mt-2">Daily Entry</h3>
    <hr />

    <div class="row mb-3 bg-light p-3 border rounded">
        <div class="col-md-3">
            <label>Type:</label>
            <select id="cmbEntryType" class="form-select">
                <option value="પેલ">પેલ (Pel)</option>
                <option value="મથાળા">મથાળા (Mathala)</option>
            </select>
        </div>
        <div class="col-md-3">
            <label>English Name:</label>
            <select id="cmbEnglishName" class="form-select">
                <option value="">-- Select --</option>
            </select>
            <input type="hidden" id="txtGujaratiName" />
        </div>
        <div class="col-md-2">
            <label>Date:</label>
            <input type="date" id="dtpDate" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
        </div>
        <div class="col-md-2">
            <label class="text-danger fw-bold">Uppad:</label>
            <input type="number" id="txtUppad" class="form-control" value="0" />
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button id="btnGenerate" class="btn btn-warning w-100 fw-bold">Generate (Alt+G)</button>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <table class="table table-bordered table-sm" id="gridTable">
                <thead class="table-dark">
                    <tr>
                        <th style="width:50px;">ID</th>
                        <th>A</th>
                        <th>B</th>
                        <th>C</th>
                        <th>D</th>
                        <th>E</th>
                        <th>F</th>
                        <th>G</th>
                        <th>Ct</th>
                        <th style="width:50px;">X</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <button class="btn btn-secondary btn-sm mb-3" onclick="addNewRow()">+ Add Row</button>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <button id="btnSave" class="btn btn-success w-100 fw-bold p-2">Save Data (Alt+S)</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // --- 1. INITIALIZATION ---
        $(document).ready(function () {
            loadEmployees(); // Load initial dropdown list

            // When Type changes, reload names
            $('#cmbEntryType').change(function () {
                loadEmployees();
            });

            // When English Name changes, set Gujarati Name
            $('#cmbEnglishName').change(function () {
                 var selectedOption = $(this).find(':selected');
                 var guj = selectedOption.data('guj'); // Get custom data attribute
                 $('#txtGujaratiName').val(guj);
            });

            // --- SHORTCUT KEYS ---
            $(document).keydown(function(e) {
                // Alt + S (Save)
                if (e.altKey && (e.key === 's' || e.key === 'S')) {
                    e.preventDefault();
                    $('#btnSave').click();
                }
                // Alt + G (Generate)
                if (e.altKey && (e.key === 'g' || e.key === 'G')) {
                    e.preventDefault();
                    $('#btnGenerate').click();
                }
            });
        });

        // --- 2. FUNCTIONS ---

        function loadEmployees() {
            var type = $('#cmbEntryType').val();
            $.get('/Entry/GetEmployees?type=' + type, function (data) {
                var $el = $("#cmbEnglishName");
                $el.empty(); // remove old options
                $el.append($("<option></option>").attr("value", "").text("-- Select --"));

                $.each(data, function (key, value) {
                    // We store Gujarati name in a 'data-guj' attribute
                    $el.append($("<option></option>")
                       .attr("value", value.englishName)
                       .data("guj", value.gujaratiName)
                       .text(value.englishName));
                });
            });
        }

        // --- 3. GENERATE / LOAD DATA ---
        $('#btnGenerate').click(function () {
            var name = $('#cmbEnglishName').val();
            if(!name) { alert("Select Name"); return; }

            var payload = {
                EnglishName: name,
                Date: $('#dtpDate').val(),
                EntryType: $('#cmbEntryType').val()
            };

            $.ajax({
                url: '/Entry/LoadData',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (resp) {
                    $('#gridTable tbody').empty(); // Clear grid

                    if (resp.rows.length > 0) {
                        $('#txtUppad').val(resp.uppad);
                        // Add existing rows
                        $.each(resp.rows, function (i, row) {
                            addNewRow(row);
                        });
                        alert("Data Loaded");
                    } else {
                        $('#txtUppad').val(0);
                        addNewRow(); // Add one blank row
                        alert("No Data Found - New Entry Mode");
                    }
                }
            });
        });

        // --- 4. GRID LOGIC (Add Row) ---
        function addNewRow(data) {
            // If data is null (new row), create empty object
            data = data || { id: 0, a: '', b: '', c: '', d: '', e: '', f: '', g: '', ct: '' };

            var html = `<tr>
                <td><input type="text" class="form-control form-control-sm" name="id" value="${data.id}" readonly style="background:#eee"></td>
                <td><input type="text" class="form-control form-control-sm" name="a" value="${data.a}"></td>
                <td><input type="text" class="form-control form-control-sm" name="b" value="${data.b}"></td>
                <td><input type="text" class="form-control form-control-sm" name="c" value="${data.c}"></td>
                <td><input type="text" class="form-control form-control-sm" name="d" value="${data.d}"></td>
                <td><input type="text" class="form-control form-control-sm" name="e" value="${data.e}"></td>
                <td><input type="text" class="form-control form-control-sm" name="f" value="${data.f}"></td>
                <td><input type="text" class="form-control form-control-sm" name="g" value="${data.g}"></td>
                <td><input type="text" class="form-control form-control-sm" name="ct" value="${data.ct}"></td>
                <td><button class="btn btn-danger btn-sm" onclick="$(this).closest('tr').remove()">X</button></td>
            </tr>`;

            $('#gridTable tbody').append(html);
        }

        // --- 5. SAVE DATA ---
        $('#btnSave').click(function () {
            var name = $('#cmbEnglishName').val();
            if(!name) { alert("Select Name first"); return; }

            // 1. Scrape Grid Data
            var gridRows = [];
            $('#gridTable tbody tr').each(function () {
                var row = $(this);
                var item = {
                    Id: row.find('input[name="id"]').val(),
                    A: row.find('input[name="a"]').val(),
                    B: row.find('input[name="b"]').val(),
                    C: row.find('input[name="c"]').val(),
                    D: row.find('input[name="d"]').val(),
                    E: row.find('input[name="e"]').val(),
                    F: row.find('input[name="f"]').val(),
                    G: row.find('input[name="g"]').val(),
                    Ct: row.find('input[name="ct"]').val()
                };
                gridRows.push(item);
            });

            // 2. Build Full Object
            var payload = {
                EnglishName: name,
                GujaratiName: $('#txtGujaratiName').val(),
                Date: $('#dtpDate').val(),
                EntryType: $('#cmbEntryType').val(),
                Uppad: $('#txtUppad').val(),
                Rows: gridRows
            };

            // 3. Send to Server
            $.ajax({
                url: '/Entry/SaveData',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (resp) {
                    if(resp.success) {
                        alert(resp.message);
                        // Optional: Clear grid or reload
                        $('#gridTable tbody').empty();
                        addNewRow();
                        $('#txtUppad').val(0);
                    } else {
                        alert("Error: " + resp.message);
                    }
                }
            });
        });

    </script>
}